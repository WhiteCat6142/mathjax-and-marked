<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta charset="utf-8">
  <title>MathJax v3 and Marked : TeX and Markdown</title>

  <script>
    MathJax = {
      tex: { inlineMath: [['<code>', '</code>'], ['$', '$'], ['\\(', '\\)']] },
      /*svg: { 
      //fontCache: 'global'
      //useGlobalCache:false,
      fontCache:"none" },*/
      //"HTML-CSS": {availableFonts:[]},
      chtml: { scale: 1 },
      startup: {
        ready: function () {
          MathJax.startup.defaultReady();
          document.getElementById('render').disabled = false;
        }
      }
    }
  </script>
  <script id="MathJax-script" async src="./mathjax-src/es5/tex-mml-chtml.js""></script>
  <script src="./marked/marked.min.js"></script>
  <script>
    //  const marked = require('marked');
    const tokenizer = {
      text(src) {
        const match = src.match(/(\$|\$\$)([^\$]+?)(\$|\$\$)/);
        if (match) {
          return {
            type: 'text',
            raw: match[0],
            text: match[2].trim()
          };
        }

        // return false to use original codespan tokenizer
        return true;
      }
    };
    //marked.setOptions({ breaks: true });

    marked.use({ tokenizer });

    function convert() {
      //
      //  Get the input (it is HTML containing delimited TeX math
      //    and/or MathML tags
      //
      var input = document.getElementById("input").value.trim();
      //
      //  Disable the render button until MathJax is done
      //
      var button = document.getElementById("render");
      button.disabled = true;
      //
      //  Clear the old output
      //
      output = document.getElementById('output');
      output.innerHTML = marked.parse(input.replace(/\\\\/g, '\\\\\\\\ ').replace(/\\(?=[^A-Za-z0-9\\\s])/g, '\\\\').replace(/_/g, " _ "));
      //
      //  Reset the tex labels (and automatic equation numbers, though there aren't any here).
      //  Reset the typesetting system (font caches, etc.)
      //  Typeset the page, using a promise to let us know when that is complete
      //
      MathJax.texReset();
      MathJax.typesetClear();
      MathJax.typesetPromise()
        .catch(function (err) {
          //
          //  If there was an internal error, put the message into the output instead
          //
          output.innerHTML = '';
          output.appendChild(document.createElement('pre')).appendChild(document.createTextNode(err.message));
        })
        .then(function () {
          //
          //  Error or not, re-enable the render button
          //
          button.disabled = false;
        });
    }
  </script>
  <style>
    #frame {
      max-width: 850px;
      margin: auto;
      background-color: #ffffda;
    }

    #input {
      border: 1px solid grey;
      margin: 0 0 .25em;
      width: 100%;
      box-sizing: border-box;

    }

    @media print {
      #in {
        display: none;
      }

      #frame {
        margin: 0px;
      }

      body {
        margin: 0px !important;
        padding: 0px !important;
      }

      #output {
        margin: .25em !important;
        padding: 1em !important;
        font-size: 14px !important;
        min-height: 800px !important;
      }

      p {
        letter-spacing: 0.175em;
      }
    }

    @media screen {
      #output {
        margin-top: .75em;
        padding: 3em;
        min-height: 1160px;
        font-size: 18px;
        color: #4d4542;
      }
    }

    #output>pre {
      margin-left: 5px;
    }

    mjx-container[jax="SVG"][display="true"] {
      margin: 10px -50px !important;
    }

    .right {
      float: right;
    }
  </style>
</head>

<body>
  <div id="frame">
    <div id="in">
      <h1>MathJax v3 &amp; Marked : TeX &amp; Markdown</h1>

      <textarea id="input" rows="15" cols="10">&lt;!--  Enter HTML containing TeX or MathML below --&gt;

If $a \ne 0$, then $ax^2 + bx + c = 0$ has two solutions,
$$x = {-b \pm \sqrt{b^2-4ac} \over 2a}.$$

As MathML:
&lt;math&gt;
  &lt;mi&gt;a&lt;/mi&gt;
  &lt;msup&gt;
    &lt;mi&gt;x&lt;/mi&gt;
    &lt;mn&gt;2&lt;/mn&gt;
  &lt;/msup&gt;
  &lt;mo&gt;+&lt;/mo&gt;
  &lt;mi&gt;b&lt;/mi&gt;
  &lt;mi&gt;x&lt;/mi&gt;
  &lt;mo&gt;+&lt;/mo&gt;
  &lt;mi&gt;c&lt;/mi&gt;
  &lt;mo&gt;=&lt;/mo&gt;
  &lt;mn&gt;0&lt;/mn&gt;
&lt;/math&gt;.
</textarea>
      <br>
      <div class="right">
        <input type="button" value="Render HTML" id="render" onclick="convert()">
      </div>
      <br clear="all">
    </div>
    <div id="output"></div>
  </div>
</body>

</html>
